import groovy.json.JsonSlurper

def ModulesConfig = copySpec{
    includeEmptyDirs = true
    from 'template'
    exclude "build", "*.class", "*.iml", "src/main/java/*"
}

task ModulesCtreation {
    ext.modulesConfig = []
    doFirst {
        def configTemp= new File("modules.json")
        if (configTemp.exists()) {
            def configs = new JsonSlurper().parse(configTemp)
            if (configs.size() > 0) {
                configs.forEach { config ->
                    def moduleDir = new File(config.moduleName)
                    if (!moduleDir.exists() | !moduleDir.isDirectory()) {
                        modulesConfig.add(config)
                        def binding = [
                                "applicationId": config.applicationId,
                                "packageName": config.packageName,
                                "apkName": "${config.moduleName}.apk"
                        ]
                        copy {
                            expand binding
                            with ModulesConfig
                            into config.moduleName
                        }
                    }
                }
            }
        }
    }

    doLast{
        println modulesConfig
        if (!modulesConfig.isEmpty()) {
            modulesConfig.forEach{
                mkdir "${it.moduleName}/src/main/java/${it.applicationId.replaceAll('\\.', '/')}"
            }
        }
    }
}

task cleanTest(type: Delete) {
    delete "test"
}