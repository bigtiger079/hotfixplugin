import groovy.json.JsonSlurper

def ModulesConfig = copySpec{
    includeEmptyDirs = true
    from 'template'
    exclude "build", "*.class", "*.iml", "src/main/java/*"
}

task ModulesCtreation {
    ext.modulesConfig = []
    doFirst {
        def configTemp= new File("modules.json")
        if (configTemp.exists()) {
            def configs = new JsonSlurper().parse(configTemp)
            if (configs.size() > 0) {
                configs.forEach {
                    def name = it.moduleName
                    def moduleDir = new File(name)
                    if (!moduleDir.exists() | !moduleDir.isDirectory()) {
                        modulesConfig.add(it)
                        def binding = [applicationId:it.applicationId, packageName:it.packageName, apkName:name+".apk"]
                        copy {
                            expand binding
                            with ModulesConfig
                            into name
                        }
                    }
                }
            }
        }
    }

    doLast{
        println modulesConfig
        if (!modulesConfig.isEmpty()) {
            modulesConfig.forEach{
                mkdir "${it.moduleName}/src/main/java/${it.applicationId.replaceAll('\\.', '/')}"
            }
        }
    }
}

task cleanTest(type: Delete) {
    delete "test"
}